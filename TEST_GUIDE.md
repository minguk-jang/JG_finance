# ✅ 기능 테스트 가이드

두 가지 주요 기능이 구현되었습니다:
1. **역할 변경 기능** - Admin이 가족 구성원의 역할을 변경
2. **프로필 사진 업로드** - 모든 사용자가 자신의 프로필 사진 업로드

---

## 🚀 설정 단계 (필수!)

### 1단계: 역할 변경 기능 활성화

**문제:** 역할 변경이 저장되지 않음
**해결:** Supabase에 RLS 정책 적용 필요

#### 실행 방법:
1. https://supabase.com 접속 → JG Finance 프로젝트 선택
2. **SQL Editor** 클릭
3. **`URGENT_FIX_USER_ROLES.md`** 파일을 열어서 SQL 복사
4. SQL Editor에 붙여넣고 **Run** 클릭
5. "Success" 메시지 확인

#### 예상 시간: 2분

---

### 2단계: 프로필 사진 업로드 기능 활성화

**필요 작업:** Supabase Storage 버킷 생성

#### 실행 방법:
1. https://supabase.com → JG Finance 프로젝트
2. **Storage** 메뉴 클릭
3. **New bucket** 클릭
4. **`SETUP_AVATAR_STORAGE.md`** 파일의 가이드 따라 설정
5. 버킷 생성 후 Storage Policies 설정

#### 예상 시간: 5분

---

## 🧪 기능 테스트

### 테스트 1: 역할 변경 (Admin만 가능)

**사전 조건:**
- Admin 계정으로 로그인
- 최소 2명의 사용자 존재

**테스트 순서:**
1. 설정 탭 → 가족 구성원 섹션으로 이동
2. 다른 사용자의 "수정" 버튼 클릭
3. "역할" 드롭다운에서 다른 역할 선택 (예: Viewer → Editor)
4. "저장" 버튼 클릭
5. "구성원 정보가 수정되었습니다" 알림 확인
6. **페이지 새로고침** (Cmd+R 또는 Ctrl+R)
7. 역할이 변경되었는지 확인

**예상 결과:**
✅ 역할 변경이 저장됨
✅ 새로고침 후에도 변경사항 유지됨

**실패 시:**
→ `URGENT_FIX_USER_ROLES.md`의 SQL을 다시 실행했는지 확인

---

### 테스트 2: 일반 사용자 자기 정보 수정

**사전 조건:**
- Viewer 또는 Editor 계정으로 로그인

**테스트 순서:**
1. 설정 탭 → 가족 구성원 섹션
2. 자신의 "수정" 버튼 클릭 (또는 "내 정보 수정")
3. 이름 변경
4. **역할 드롭다운이 비활성화되어 있는지 확인**
5. "저장" 클릭
6. 새로고침 후 이름 변경 확인

**예상 결과:**
✅ 자신의 이름/아바타는 수정 가능
✅ 역할은 수정 불가 (비활성화됨)
⛔ 다른 사용자의 "수정" 버튼은 클릭 불가

---

### 테스트 3: 프로필 사진 업로드

**사전 조건:**
- Supabase Storage 버킷 생성 완료
- 테스트용 이미지 파일 준비 (2MB 이하)

**테스트 순서:**
1. 설정 탭 → 가족 구성원 → "수정" 클릭
2. "프로필 사진" 섹션에서 "이미지 업로드" 버튼 클릭
3. 이미지 파일 선택
4. 미리보기가 즉시 표시되는지 확인
5. "저장" 클릭
6. "업로드 중..." 표시 확인
7. 성공 알림 후 모달 닫힘
8. 가족 구성원 테이블에서 프로필 사진 변경 확인

**예상 결과:**
✅ 이미지 선택 시 즉시 미리보기 표시
✅ 업로드 중 로딩 스피너 표시
✅ 업로드 완료 후 프로필 사진 변경됨
✅ 다른 탭에서도 변경된 아바타 표시됨

**실패 시:**
→ `SETUP_AVATAR_STORAGE.md` 가이드를 다시 확인
→ Supabase Storage → Policies가 모두 활성화되어 있는지 확인

---

### 테스트 4: 파일 크기/형식 검증

**테스트 시나리오:**

#### 시나리오 A: 2MB 초과 파일 업로드
1. 3MB 이상의 이미지 파일 선택
2. "파일 크기는 2MB 이하여야 합니다" 알림 확인
3. 업로드 실패

#### 시나리오 B: 이미지가 아닌 파일 업로드
1. PDF, TXT 등 비이미지 파일 선택
2. "이미지 파일만 업로드할 수 있습니다" 알림 확인
3. 업로드 실패

#### 시나리오 C: 유효한 이미지 형식
- ✅ JPG/JPEG
- ✅ PNG
- ✅ GIF
- ✅ WebP

---

### 테스트 5: 통합 테스트 (역할 변경 + 프로필 사진)

**테스트 순서:**
1. Admin으로 로그인
2. 다른 사용자 수정 → 역할을 Editor로 변경 + 프로필 사진 업로드
3. 저장 후 새로고침
4. 두 변경사항 모두 적용되었는지 확인
5. Editor 계정으로 로그인
6. 지출 탭에서 데이터 입력 가능 확인 (Editor 권한)

**예상 결과:**
✅ 역할과 프로필 사진이 동시에 변경됨
✅ 변경된 역할에 따라 권한이 적용됨

---

## 🐛 문제 해결

### 문제 1: "Policy violation" 에러

**원인:** RLS 정책 미적용
**해결:**
1. Supabase Dashboard → SQL Editor
2. `URGENT_FIX_USER_ROLES.md`의 SQL 실행
3. `SETUP_AVATAR_STORAGE.md`의 Storage Policies 실행

---

### 문제 2: 역할 변경이 저장되지 않음

**체크리스트:**
- [ ] `URGENT_FIX_USER_ROLES.md`의 SQL을 실행했는가?
- [ ] SQL 실행 후 "Success" 메시지를 받았는가?
- [ ] 현재 로그인한 계정이 Admin인가?
- [ ] 브라우저를 완전히 새로고침했는가? (Shift + Cmd + R)

**추가 확인:**
```sql
-- Supabase SQL Editor에서 실행
SELECT * FROM public.users WHERE role = 'Admin';
```
본인의 계정이 Admin으로 표시되는지 확인

---

### 문제 3: 이미지 업로드 버튼이 보이지 않음

**원인:** Supabase Storage 버킷 미생성
**해결:**
1. Supabase Dashboard → Storage
2. `avatars` 버킷 존재 확인
3. 없다면 `SETUP_AVATAR_STORAGE.md` 가이드 실행

---

### 문제 4: 이미지가 업로드되지만 표시되지 않음

**원인:** 버킷이 Private으로 설정됨
**해결:**
1. Supabase Dashboard → Storage → avatars 버킷
2. Settings 탭에서 "Public bucket" 활성화
3. Policies 탭에서 "Anyone can view avatars" 정책 확인

---

## 📊 성공 기준

모든 테스트가 통과하면 다음 기능이 작동합니다:

### ✅ 역할 관리
- [x] Admin이 다른 사용자의 역할 변경 가능
- [x] 일반 사용자는 자신의 역할 변경 불가
- [x] 역할 변경이 새로고침 후에도 유지됨

### ✅ 프로필 사진
- [x] 모든 사용자가 자신의 프로필 사진 업로드 가능
- [x] 이미지 선택 시 즉시 미리보기 표시
- [x] 업로드 중 로딩 표시
- [x] 파일 크기/형식 검증 작동
- [x] 업로드된 사진이 모든 화면에 반영됨

### ✅ 권한 관리
- [x] Admin: 모든 사용자 수정 가능
- [x] 일반 사용자: 자신만 수정 가능
- [x] 역할 변경은 Admin만 가능

---

## 🎉 완료!

모든 테스트가 통과하면 다음 기능을 사용할 수 있습니다:
- 가족 구성원의 역할을 자유롭게 관리
- 각자 개성 있는 프로필 사진 사용
- 역할에 따른 적절한 권한 부여

추가 문제 발생 시:
1. 브라우저 콘솔에서 에러 메시지 확인
2. Supabase Dashboard → Database → RLS Policies 확인
3. Supabase Dashboard → Storage → Policies 확인
